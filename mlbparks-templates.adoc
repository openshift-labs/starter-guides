In this lab, we're going to deploy a complete backend application, consisting of
a REST API backend and a MongoDB database. The complete application will already
be wired together and described as a backend for the map visualization tool, so
that once the application is built and deployed, you will be able to see the new
map.

image::roadshow-app-architecture-mlbparks.png[Application architecture,800,align="center"]

== Background: Templates
Running all these individual commands can be tedious and error prone.
Fortunately for you, all of this configuration can be put together into a single
*Template* which can then be processed to create a full set of resources. As you
saw with MongoDB, a *Template* may define parameters for certain values, such as
DB username or password, and they can be automatically generated by OpenShift at
processing time.

Administrators can load *Templates* into OpenShift and make them available to
all users, even via the web console. Users can create *Templates* and load them
into their own *Projects* for other users (with access) to share and use.

The great thing about *Templates* is that they can speed up the deployment
workflow for application development by providing a "recipe" of sorts that can
be deployed with a single command.  Not only that, they can be loaded into
OpenShift from an external URL, which will allow you to keep your templates in a
version control system. 

Let's combine all of the exercises we have performed in the last several labs by
using a *Template* that we can instantiate with a single command.  While we
could have used templates to deploy everything in the workshop today, remember
that it is important for you to understand how to create, deploy, and wire
resources together.

== Exercise: Instantiate a Template

The front end application we've been working with this whole time will display
as many back end services' data as are created. Adding more stuff with the right
*Label* will make more stuff show up on the map.

Now you will deploy a map of Major League Baseball stadiums in the US by using a
template. It is pre-configured to build the back end Java application, and
deploy the MongoDB database. It also uses a *Hook* to call the `/ws/data/load`
endpoint to cause the data to be loaded into the database from a JSON file in
the source code repository. Execute the following command:

[source,bash,role=copypaste]
----
oc create -f https://raw.githubusercontent.com/openshift-roadshow/mlbparks/master/ose3/application-template-eap.json
----

What just happened? What did you just `create`? The item that we passed to the `create`
command is a *Template*. `create` simply makes the template available in
your *Project*. You can see this with the following command:

[source,bash,role=copypaste]
----
oc get template
----

You will see output like the following:

[source,bash]
----
mlbparks      Application template MLBParks backend running on Wildfly and using mongodb   12 (2 blank)   8
----

In the web console, you can see the templates you have in your project, by clicking on the 
*"Add to project --> Select from project"* dropdown menu.

image::mlbparks-templates-from-project-menu.png[Select from project menu]

You'll be presented with a list of templates local to your own project. You will see the template we just loaded.

image::mlbparks-templates-from-project.png[Local templates]

Are you ready for the magic command?  

Here it is!

If you want to use command line:

[source,bash,role=copypaste]
----
oc new-app mlbparks -p APPLICATION_NAME=mlbparks
----

[TIP]
====
The template can also use maven for the build. In case you want to try this option
provide the *MAVEN_MIRROR_URL* parameter with the location of the internal nexus
repository:

[source,bash,role=copypaste]
----
oc new-app mlbparks --name=mlbparks -p MAVEN_MIRROR_URL=http://nexus.{{INFRA_PROJECT}}.svc.cluster.local:8081/repository/maven-all-public
----
====


You will see some output similar to this:

[source,bash]
----
--> Deploying template "user2/mlbparks" to project user2

     MLBparks
     ---------
     Application template MLBParks backend running on Wildfly and using mongodb

     * With parameters:
        * Application Name=mlbparks
        * Application route=
        * Mongodb App=mongodb-mlbparks
        * Git source repository=https://github.com/openshift-roadshow/mlbparks.git
        * Git branch/tag reference=master
        * Database name=mongodb
        * MONGODB_NOPREALLOC=
        * MONGODB_SMALLFILES=
        * MONGODB_QUIET=
        * Database user name=userGhR # generated
        * Database user password=KhnHKCQI # generated
        * Database admin password=UyUV6ReU # generated
        * GitHub Trigger=dAOuD7s4 # generated
        * Generic Trigger=tWSkmNLn # generated

--> Creating resources ...
    configmap "mlbparks" created
    service "mongodb-mlbparks" created
    deploymentconfig "mongodb-mlbparks" created
    imagestream "mlbparks" created
    buildconfig "mlbparks" created
    deploymentconfig "mlbparks" created
    service "mlbparks" created
    route "mlbparks" created
--> Success
    Build scheduled, use 'oc logs -f bc/mlbparks' to track its progress.
    Run 'oc status' to view your app.
----

Or if you prefer using the web UI, you can just click on the template we just saw. If you followed the command line steps above then *do not* follow the web console steps below. This is simply demonstrating an alternate way to instantiate the template.

image::mlparks-templates-from-project-info.png[Template info]

Then, you'll see a guided wizard showing you some information and allowing you to provide
the desired configuration to instantiate the template

image::mlparks-templates-from-project-info.png[Template config]

Go ahead and click *"Create"*

OpenShift will now:

* Configure and start a build
** Using the supplied Maven mirror URL (In case you have specified the parameter)
** From the supplied source code repository
* Configure and deploy MongoDB
** Using auto-generated user, password, and database name
* Configure environment variables for the app to connect to the DB
* Create the correct services
* Label the app service with `type=parksmap-backend`

All with one command!

When the build is complete, visit the parks map. Does it work? Think about how
this could be used in your environment.  For example, a template could define a
large set of resources that make up a "reference application", complete with
several app servers, databases, and more.  You could deploy the entire set of
resources with one command, and then hack on them to develop new features,
microservices, fix bugs, and more.

image::mlbparks-templates-complete-overview.png[Complete overview]

As a final exercise, look at the template that was used to create the
resources for our *mlbparks* application.

[source,bash,role=copypaste]
----
oc get template mlbparks -o yaml
----

But as always, you can use the OpenShift web console to do the same. Under *"Resources menu"*, click on *"Other resources"*,
then select *"Templates*" from the dropdown, and select the *"Edit YAML"* action, on the *"Actions"* dropdown. 

image::mlbparks-templates-yaml-menu.png[Complete overview]

You'll be able to see/edit the YAML as well from here.

image::mlbparks-templates-yaml-edit.png[Template YAML edit]
